<!-- (C) 2015 Rozum Halina, BSUIR -->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//RU">
<HTML>

<HEAD>
    <LINK rel=stylesheet href="../../Оболочка/css/style.css" type=text/css>
    <META HTTP-EQUIV="Content-Type" CONTENT="text/html" charset="utf8">
    <META HTTP-EQUIV="Content-Language" CONTENT="ru">
    <title> Практика по дисциплине &quot;Операционные системы, базы данных&quot;</title>
    <base target="_top">
</HEAD>

<BODY>
    <table width="100%" border="0" cellpadding="0" cellspacing="3" background="../../Оболочка/images/background.jpg">
        <tr>
            <td width="13%" rowspan=3 align="center"><img src="../../Оболочка/images/logo_new.jpg" width=117 align="middle">
            </td>
            <tr>
                <td width="70%" colspan=2 align="center" valign="middle">
                    <H1 align="center">электронный
        ресурс по учебной дисциплине<BR>
        &quot;Операционные системы, базы данных&quot;<BR>
        для специальности: </H1> 1-58 01 01 - &quot;ИНЖЕНЕРНО-ПСИХОЛОГИЧЕСКОЕ ОБЕСПЕЧЕНИЕ ИНФОРМАЦИОННЫХ ТЕХНОЛОГИЙ&quot;.
                </td>
                <td width="12%" rowspan=3 align="center">&nbsp;</td>
  <Tr>
    <td align=center colspan=2><var class="normal">
                                                  <A HREF="../../index.htm">Оглавление</A> |
                                                  <A HREF="../../Программа/program.html" TITLE="Программа курса (Откроется в новом окне)">Программа</A> |
                                                  <A HREF="../../Теория/theory.htm">Теория</A> |
                                                  <strong>Практика</strong>|
                                                  <A HREF="../../Контроль_знаний/test.htm">Контроль знаний</A> |
                                                  <A HREF="../../Об авторах/author.htm">Об авторах</A>
     </var></var> </td>
  </tr>
    </table>
    <P class="margined">
        <FONT SIZE=4>
            <CENTER>
            </CENTER>
        </FONT>
        <table style="margin:0 auto;" width="90%" border="0" cellpadding="0" cellspacing="0">
            <td>
 <A HREF="../practice.htm">Оглавление</A>
                <p>&nbsp;</p>
                 <div> 

<p><b><span>Лабораторная работа 3. Создание хранимых процедур</span></b></p>
<p><![if !supportLists]><b><span><span>1.<span> </span></span></span></b><![endif]><b><span>Цель работы<o:p></o:p></span></b></p> <p><span>Формирование практических умений по созданию хранимых процедур для БД </span><span>ORACLE</span><span>.<o:p></o:p></span></p> <p><a><b><span>2. Учебный материал по </span></b></a><span><span><b><span>лабораторной</span></b></span></span><span></span><b><span><o:p></o:p></span></b></p> <p><span>Есть много способов обработки баз данных </span><span>Oracle</span><span> из приложений. Один из способов заключается в том, чтобы создавать приложения на C++, С#, </span><span>Java</span><span>, </span><span>Visual</span><span> </span><span>Basic</span><span> или каком-либо другом языке программирования и вызывать из них программы </span><span>Oracle</span><span>. Для этого можно воспользоваться кодовыми библиотеками </span><span>Oracle</span><span> или задействовать промышленные стандарты </span><span>ODBC</span><span> или </span><span>JDBC</span><span>. <span><o:p></o:p></span></span></p> <p><span>Другой способ обработки баз данных </span><span>Oracle</span><span> состоит в написании процедур на </span><span>PL</span><span>/</span><span>SQL</span><span>. Эти процедуры можно хранить в виде файлов, запускаемых по команде </span><span>START</span><span> в </span><span>SQL</span><span> </span><span>Plus</span><span>, в виде хранимых процедур в базе данных, а также в виде триггеров, которые вызываются при наступлении определенных событий. Рассмотрим каждый из этих вариантов.<a><span><o:p></o:p></span></a></span></p> <p><span><span>Обработка файлов PL/SQL</span></span><span><o:p></o:p></span></p> <p><span>Если пользователь базы данных имеет доступ к </span><span>SQL</span><span> </span><span>Plus</span><span>, он может сохранить операторы </span><span>PL</span><span>/</span><span>SQL</span><span> в файле и запускать их напрямую командой </span><span>START</span><span>. Файл, содержащий оператор<span><o:p></o:p></span></span></p> <p><span>SELECT</span><span><span> </span>*<o:p></o:p></span></p> <p><span>FROM</span><span><span> </span></span><span><span>ExpensiveArt</span></span><span>:<o:p></o:p></span></p> <p><span>/<o:p></o:p></span></p> <p><span>можно сохранить под именем </span><span><span>ToSell</span></span><span>.</span><span><span>sqL</span></span><span> Пользователь откроет </span><span>SQL</span><span> </span><span>Plus</span><span> и введет команду<span><o:p></o:p></span></span></p> <p><span>Start</span><span> </span><span><span>ToSell</span></span><span>:<o:p></o:p></span></p> <p><span>В результате будут выведены данные из представления </span><span><span>ExpensiveArt</span></span><span>.<o:p></o:p></span></p> <p><span>В реальности большинство пользователей в деловом мире не имеет доступа к </span><span>SQL</span><span> </span><span>Plus</span><span>, а если бы и имели, то вряд ли работа с этой программой пришлась бы им по вкусу. Однако этот стиль обработки используется администраторами и разработчиками баз данных для автоматизации рутинных задач администрирования.<a><span><o:p></o:p></span></a></span></p> <p><span><span>Хранимые процедуры</span></span><span><o:p></o:p></span></p> <p><span>Хранимая процедура — это программа на языке </span><span>PL</span><span>/</span><span>SQL</span><span> или </span><span>Java</span><span>, которая хранится в базе данных. Хранимые процедуры могут иметь параметры, вызывать другие процедуры и функции, возвращать значения и генерировать исключения. Хранимые процедуры могут вызываться удаленно. Мы рассмотрим два примера х<a>ранимых процедур.<o:p></o:p></a></span></p> <p><span><span>Хранимая процедура <span>Customer_Insert</span></span></span><span><o:p></o:p></span></p> <p><span>Галерее </span><span>View</span><span> </span><span>Ridge</span><span> требуется возможность добавлять в базу данных новых клиентов и записывать информацию о художниках, работами которых клиенты интересуются. В частности, нужно записывать имя и телефоны клиента, а также ассоциировать его со всеми художниками выбранной национальности.<span><o:p></o:p></span></span></p> <p><![if !supportLists]><span><span>1.<span> </span></span></span><![endif]><span>Выполнить процедуру<o:p></o:p></span></p> <p><span>В листинге 1 показана хранимая процедура, выполняющая эту задачу. Процедура, которая называется </span><span>Customer</span><span>_</span><span><span>Inse</span><span>r</span></span><span>t</span><span>, принимает четыре параметра:<span><o:p></o:p></span></span></p> <p><span><span><span>newname</span></span></span><span> (имя нового клиента), </span><span><span>newareacode</span></span><span> (код региона), </span><span><span>newphone</span></span><span> (телефон) и </span><span><span>artistnationality</span></span><span> (национальность художника). Ключевое слово </span><span>IN</span><span> указывает на то, что вес эти параметры являются входными. Выходные параметры (которых у этой процедуры нет) обозначаются ключевым словом </span><span>OUT</span><span>, а параметры, играющие роль и входных, и выходных, — сочетанием </span><span>IN</span><span> </span><span>OUT</span><span>. Обратите внимание, что для параметра указывается тип данных, но не длина. </span><span><span>Oracle </span><span>определит</span><span> </span><span>длину</span><span> </span><span>из</span><span> </span><span>контекста</span><a><span>.</span></a></span><span><span><o:p></o:p></span></span></p> <p><span><span>Листинг</span></span><span><span> 1.<span> </span> </span></span><span><span>Процедура</span></span><span><span> <span>CustomerInsert</span></span></span><span><o:p></o:p></span></p> <p><span>CREATE OR REPLACE PROCEDURE <span>CustomerInsert</span><o:p></o:p></span></p> <p><span>(<o:p></o:p></span></p> <p><span><span><span>newname</span></span></span><span><span> </span>IN<span> </span>char,<o:p></o:p></span></p> <p><span><span><span>newareacode</span></span></span><span><span> </span><span> </span>IN<span> </span>char,<o:p></o:p></span></p> <p><span><span><span>newphone</span></span></span><span><span> </span>IN<span> </span>char,<o:p></o:p></span></p> <p><span><span><span>artistnationality</span></span></span><span><span> </span>IN<span> </span>char<o:p></o:p></span></p> <p><span>)<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>AS<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span><span><span>rowcount</span></span></span><span> integer(4);<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>CURSOR<span> </span><span>artistcursor</span> IS<o:p></o:p></span></p> <p><span>SELECT <span>ArtistID</span><o:p></o:p></span></p> <p><span>FROM ARTIST<o:p></o:p></span></p> <p><span>WHERE Nationality=<span>artistnationality</span><o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>BEGIN<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>SELECT<span> </span>Count (*) INTO <span>rowcount</span><o:p></o:p></span></p> <p><span>FROM<span> </span><span> </span>CUSTOMER<o:p></o:p></span></p> <p><span>WHERE<span> </span>Name=<span>newnaine</span> AND Area_Code5newareacode AND <span>Phone_Number</span> = <span>newphone</span>;<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>IF</span><span> </span><span><span>rowcount</span></span><span> > 0 </span><span>THEN</span><span><o:p></o:p></span></p> <p><span>BEGIN</span><span><o:p></o:p></span></p> <p><span>DBMS</span><span>_</span><span>OUTPUT</span><span>.</span><span>PUT</span><span>_</span><span>LINE</span><span> ('Клиент уже есть в базе данных - никаких действий не предпринято');<o:p></o:p></span></p> <p><span>RETURN;<o:p></o:p></span></p> <p><span>END;<o:p></o:p></span></p> <p><span>END IF;<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>INSERT INTO CUSTOMER<o:p></o:p></span></p> <p><span>(<span>CustomerID</span>, Name, <span>Area_Code</span>, <span>Phone_Number</span>)<o:p></o:p></span></p> <p><span>VALUES<o:p></o:p></span></p> <p><span>(<span>CustID.NextVal</span>, <span>newname</span>, <span>newareacode</span>, <span>newphone</span>);<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>FOR artist IN <span>artistcursor</span><o:p></o:p></span></p> <p><span>LOOP<o:p></o:p></span></p> <p><span>INSERT INTO CUSTOMER_ARTIST_INT<o:p></o:p></span></p> <p><span>(<span>CustomerID</span>, <span>ArttstID</span>)<o:p></o:p></span></p> <p><span>VALUES<o:p></o:p></span></p> <p><span>(<span>CustID.CurrVal</span>, <span>artist.ArtistID</span>);<o:p></o:p></span></p> <p><span>END LOOP;<o:p></o:p></span></p> <p><span>DBMS</span><span>_</span><span>OUTPUT</span><span>.</span><span>PUT</span><span>_</span><span>LINE</span><span> (<span>‘ Новый</span> клиент успешно добавлен в базу ');<o:p></o:p></span></p> <p><span>END;<o:p></o:p></span></p> <p><span>/<o:p></o:p></span></p> <p><span>Раздел объявления переменных следует за ключевым словом AS. Оператор SELECT определяет переменную-курсор (<span>cursor</span> <span>variable</span>) с именем <span>artistcursor</span>. Этот курсор выделяет из таблицы ARTIST для обработки строки всех художников заданной национальности.<o:p></o:p></span></p> <p><span>В первом разделе процедуры выполняется проверка, нет ли уже в базе информации о данном клиенте. В этом случае никакие действия не предпринимаются, а пользователю с помощью пакета <span>Oracle</span> DBMS_OUTPUT выводится соответствующее сообщение.<o:p></o:p></span></p> <p><span>Обратите внимание, что пользователь получит это сообщение только в том случае, если процедура будет вызвана из SQL <span>Plus</span>. В случае вызова процедуры иным путем, например с помощью браузера через Интернет, пользователь не увидит этого сообщения. Чтобы сообщить пользователю об ошибке, разработчик должен воспользоваться выходным параметром или сгенерировать исключение. Синтаксис для вывода строки и значения переменной, хотя это не показано в листинге 1, имеет вид <o:p></o:p></span></p> <p><span>DBMS_OUTPUT.PUT_ </span><span>LIN</span><span><span>Е(</span></span><span>'строка'//переменная).<o:p></o:p></span></p> <p><span>Кроме того, чтобы такие сообщения стали видимыми, следует выполнить команду<o:p></o:p></span></p> <p><span><span>Set</span></span><span> <span>serveroutput</span> <span>on</span>:<o:p></o:p></span></p> <p><span>Если при работе в SQL <span>Plus</span> Вы не видите сообщений, выводимых вашими процедурами, скорее всего, вы не выполнили этот оператор.<o:p></o:p></span></p> <p><span>Оставшаяся часть процедуры в листинге 1 вставляет данные о новом клиенте и затем перебирает всех художников выбранной национальности. Обратите внимание на использование специальной конструкции PL/SQL:<o:p></o:p></span></p> <p><span>FOR <span>artist</span> IN <span>artistcursor</span>.<o:p></o:p></span></p> <p><span>Эта конструкция выполняет несколько задач. Прежде всего, она открывает курсор и считывает первую строку. <span>Затем она последовательно обрабатывает все строки под курсором и по окончании обработки передает управление следующему оператору после FOR.<o:p></o:p></span></span></p> <p><span><span> </span>Заметьте также, что обращение к столбцу </span><span><span>ArtistID</span></span><span> текущей строки происходит с использованием синтаксиса </span><span>artist</span><span>.</span><span><span>ArtistID</span></span><span>, где </span><span>artist</span><span> — это имя <span>переменной цикла</span> </span><span>FOR</span><span>, а не курсора.<o:p></o:p></span></p> <p><![if !supportLists]><span><span>2.<span> </span></span></span><![endif]><span>Скомпилировать и сохранить процедуру в базе данных<o:p></o:p></span></p> <p><span>После того как процедура написана, ее необходимо скомпилировать и сохранить в базе данных. Наберите те<span>кст пр</span>оцедуры в редакторе и сохраните его под именем, скажем, </span><span>SP</span><span>_</span><span>CI</span><span>.</span><span><span>sql</span></span><span>. Если в последней строке файла вы поместите косую черту, то процедура будет скомпилирована и сохранена в базе данных автоматически после ввода команды<o:p></o:p></span></p> <p><span>Start</span><span> </span><span>SP</span><span>_</span><span>CI</span><span><o:p></o:p></span></p> <p><span>Если вы что-то ввели неправильно, у нас могут возникнуть ошибки компиляции. К сожалению, </span><span>SQL</span><span> </span><span>Plus</span><span> не покажет вам эти ошибки автоматически, а выдаст сообщение: «</span><span>Warning</span><span>: </span><span>Procedure</span><span> </span><span>created</span><span> </span><span>with</span><span> </span><span>compilation</span><span> </span><span>errors</span><span>» («Предупреждение: при компиляции процедуры обнаружены ошибки»). <o:p></o:p></span></p> <p><![if !supportLists]><span><span>3.<span> </span></span></span><![endif]><span>Чтобы увидеть ошибки, введите команду <o:p></o:p></span></p> <p><span>Show</span><span> </span><span>errors</span><span>;<o:p></o:p></span></p> <p><span>Если синтаксических ошибок не было, вы получите сообщение «</span><span>Procedure</span><span> </span><span>created</span><span>» («Процедура создана»). Теперь вы можете вызывать эту процедуру с помощью команд </span><span>EXECUTE</span><span> или ЕХЕС:<o:p></o:p></span></p> <p><span>Exec <span>Customer_<span>Insert</span></span><span>(</span>‘Selma Warning', '206', '555-0099', 'US');<o:p></o:p></span></p> <p><span>Если возникнут ошибки на этапе выполнения процедуры, номера строк в отчете об ошибках не будут совпадать с номерами строк, которые вы можете видеть в своем текстовом редакторе. Можно настроить </span><span>SQL</span><span> </span><span>Plus</span><span> так, чтобы выводимые номера строк соответствовали <span>вашим</span> (но мы это не рассматриваем!) Главное, имейте в виду, что номера строк могут не совпадать.<o:p></o:p></span></p> <p><a><span>Хранимая процедура </span></a><span><span><span>NewCustomerWithTransaction</span></span></span><span></span><span><o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>Приведем листинг 2 хранимой процедуры, реализующей процесс создания представления <o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>Листинг</span><span> 2 </span><span><span> </span></span><span>Процедура</span><span> <span>NewCustomerWithTransaction</span><o:p></o:p></span></p> <p><span>CREATE OR REPLACE PROCEDURE <span>NewCustoirierWithTransaction</span><o:p></o:p></span></p> <p><span>(<o:p></o:p></span></p> <p><span><span><span>newnawe</span></span></span><span> IN char,<o:p></o:p></span></p> <p><span><span><span>newareacode</span></span></span><span> IN char,<o:p></o:p></span></p> <p><span><span><span>newphone</span></span></span><span> IN char,<o:p></o:p></span></p> <p><span><span><span>artistname</span></span></span><span> IN char,<o:p></o:p></span></p> <p><span><span>worktit1e</span></span><span> IN char,<o:p></o:p></span></p> <p><span><span><span>workcopy</span></span></span><span> IN char,<o:p></o:p></span></p> <p><span><span>price</span></span><span> IN number<o:p></o:p></span></p> <p><span>)<o:p></o:p></span></p> <p><span>AS<span><o:p></o:p></span></span></p> <p><span><span><span>rowcount</span></span></span><span> integer (2) :<span><o:p></o:p></span></span></p> <p><span><span><span>tid</span></span></span><span><span> </span><span>int</span>:<span><o:p></o:p></span></span></p> <p><span><span>aid</span></span><span><span> </span><span>int</span>;<span><o:p></o:p></span></span></p> <p><span>CURSOR<span> </span><span>transcursor</span> IS<o:p></o:p></span></p> <p><span><span>SELECT<span> </span><span>TransactionID</span></span></span><span>, <span>ARTIST.ArtlstID</span><span><o:p></o:p></span></span></p> <p><span>FROM<span> </span>ARTIST, WORK, TRANSACTION<span><o:p></o:p></span></span></p> <p><span>WHERE Name=<span>artistname</span> AND Tit1e=worktit1e AND<o:p></o:p></span></p> <p><span>Copy=<span>workcopy</span> AND<o:p></o:p></span></p> <p><span><span>TRANSACTION.CuStomerID</span></span><span> IS NULL AND<o:p></o:p></span></p> <p><span><span>ARTIST.ArtlstID</span></span><span> <sup>=</sup> <span>WORK.ArtistID</span> AND<o:p></o:p></span></p> <p><span><span>WORK.WorkID</span></span><span> = <span>TRANSACTION.WorkID</span>;<span><o:p></o:p></span></span></p> <p><span><o:p> </o:p></span></p> <p><span>BEGIN</span><span><o:p></o:p></span></p> <p><span>/* Клиент уже есть в базе данных? </span><span>*/<span><o:p></o:p></span></span></p> <p><span><o:p> </o:p></span></p> <p><span>SELECT<span> </span>Count (*) INTO <span>rowcount</span><span><o:p></o:p></span></span></p> <p><span>FROM<span> </span>CUSTOMER<span><o:p></o:p></span></span></p> <p><span>WHERE<span> </span>Name=<span>newname</span> AND <span>Area_Code</span>=<span>newareacode</span> AND<o:p></o:p></span></p> <p><span><span>Phone_Number</span></span><span> = <span>newphone</span><span><o:p></o:p></span></span></p> <p><span>IF <span>rowcount</span> > 0 THEN<o:p></o:p></span></p> <p><span>BEGIN<span><o:p></o:p></span></span></p> <p><span>DBMS_OUTPUT.PUT_LINE ('Customer Already Exists – No<o:p></o:p></span></p> <p><span>Action Taken');<span><o:p></o:p></span></span></p> <p><span>RETURN;<span><o:p></o:p></span></span></p> <p><span>END;<span><o:p></o:p></span></span></p> <p><span>END IF;<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>/* Клиента нет в базе данных, добавляем нового клиента */<o:p></o:p></span></p> <p><span>INSERT INTO CUSTOMER<span><o:p></o:p></span></span></p> <p><span>(<span>CustomerID</span>, Name, <span>Area_Code</span>, <span>Phone_Number</span>)<o:p></o:p></span></p> <p><span>VALUES<span><o:p></o:p></span></span></p> <p><span>(<span>CustID.NextVal</span>, <span>newname</span>, <span>newareacode</span>, <span>newphone</span>);<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>/* Ищем одну и только одну свободную строку в таблице </span><span>TRANSACTION</span><span>. </span><span>*/<o:p></o:p></span></p> <p><span><span><span>rowcount</span></span></span><span> :5 0;<span><o:p></o:p></span></span></p> <p><span>FOR <span>trans</span> In <span>transcursor</span><o:p></o:p></span></p> <p><span>LOOP<span><o:p></o:p></span></span></p> <p><span><span><span>tid</span></span></span><span> := <span>trans.TransactionID</span>;<span><o:p></o:p></span></span></p> <p><span><span>aid</span></span><span> := <span>trans.ArtistID</span>;<span><o:p></o:p></span></span></p> <p><span><span><span>rowcount</span></span></span><span> := <span>rowcount</span> + 1;<span><o:p></o:p></span></span></p> <p><span>END LOOP;<span><o:p></o:p></span></span></p> <p><span>IF <span>rowcount</span> > 1 Then<o:p></o:p></span></p> <p><span>BEGIN</span><span><o:p></o:p></span></p> <p><span>/* Слишком много свободных строк<span> -- </span>выдаем сообщение об ошибке, отменяем изменения и выходим из процедуры */<span><o:p></o:p></span></span></p> <p><span>ROLLBACK</span><span>;<span><o:p></o:p></span></span></p> <p><span>DBMS</span><span>_</span><span>OUTPUT</span><span>.</span><span>PUT</span><span>_</span><span>LINE</span><span> (<span>‘ Неверные</span> данные в таблицах </span><span>ARTIST</span><span>/</span><span>WORK</span><span>/</span><span>TRANSACTION</span><span> -- никаких действий не предпринято ‘);<o:p></o:p></span></p> <p><span>RETURN;<o:p></o:p></span></p> <p><span>END;<o:p></o:p></span></p> <p><span>END IF;<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> <p><span>IF <span>rowcount</span> 5 0 Then<o:p></o:p></span></p> <p><span>BEGIN</span><span><o:p></o:p></span></p> <p><span>/* Нет ни одной свободной строки – выдаем<o:p></o:p></span></p> <p><span>сообщение об ошибке, отменяем изменения и выходим из процедуры */<o:p></o:p></span></p> <p><span>ROLLBACK;<o:p></o:p></span></p> <p><span><span>DBMS_</span><span>O</span><span>UTPUT.PUT_LINE (' Ни одной свободной строки</span></span><span><o:p></o:p></span></p> <p><span>в таблице TRANSACTION -- никаких действий не предпринято ');<o:p></o:p></span></p> <p><span>RETURN;<o:p></o:p></span></p> <p><span>END;<o:p></o:p></span></p> <p><span>END IF:<o:p></o:p></span></p> <p><span>/* Есть ровно одна строка<span> -- </span>используем ее. Идентификатор транзакции<span>.</span> <span>п</span>олученный из <span>transcursor</span>, находится в переменной <span>ttd</span> */<o:p></o:p></span></p> <p><span>DBMS_OUTPUT.PUT_LINE (t1d);<o:p></o:p></span></p> <p><span>UPDATE TRANSACTION<o:p></o:p></span></p> <p><span>SET<span> </span><span>CustomerID</span> = <span><span>CustID.Currvat</span></span><span> ,</span><o:p></o:p></span></p> <p><span><span>Salesprtce</span></span><span> = price, <span>PurchaseDate</span> = <span>SysDate</span><o:p></o:p></span></p> <p><span>WHERE<span> </span><span>TransactionID</span> – <span>tid</span>;<o:p></o:p></span></p> <p><span>DBMS</span><span> </span><span>OUTPUT</span><span>.</span><span>PUT</span><span>_</span><span>LINE</span><span> (<span>‘ Клиент</span> добавлен в базу данных, данные транзакций обновлены ');<o:p></o:p></span></p> <p><span>/* Теперь регистрируем интерес данного клиента к <span>данному</span><o:p></o:p></span></p> <p><span>художнику */<o:p></o:p></span></p> <p><span>/* Используем идентификатор художника, находящийся <span>в</span><o:p></o:p></span></p> <p><span>переменной <span>aid</span>. и текущее значение последовательности<o:p></o:p></span></p> <p><span><span>CurrVal</span></span><span> */<o:p></o:p></span></p> <p><span>INSERT INTO CUSTOMER_ARTIST INT (<span>ArtistID</span>, <span>CustomerID</span>)<o:p></o:p></span></p> <p><span>VALUES (aid, <span>CuitID.CurrVal</span>);<o:p></o:p></span></p> <p><span>END;<o:p></o:p></span></p> <p><span>/<o:p></o:p></span></p> <p><span>Логика</span><span> </span><span>этой</span><span> </span><span>процедуры</span><span>, </span><span>носящей</span><span> </span><span>имя</span><span> <span>NewCustomerWithTransaction</span>, </span><span>такова</span><span>. </span><span>Сначала создаются данные нового клиента, и в таблице </span><span>TRANSACTION</span><span>, где регистрируются купленные произведения, ведется пои<span>ск стр</span>ок, и которых столбец </span><span><span>CustomerID</span></span><span> имеет пустое значение. Этот поиск ведется по соединению таблиц </span><span>ARTIST</span><span>, </span><span>WORK</span><span> и </span><span>TRANSACTION</span><span>, так как имя художника (</span><span>Name</span><span>) хранится в таблице </span><span>ARTIST</span><span>, а название произведения (</span><span>Title</span><span>) и номер копии (</span><span>Copy</span><span>) хранятся в таблице </span><span>WORK</span><span>. Если найдена ровно одна такая строка, в ней обновляются столбцы </span><span><span>CustomerID</span></span><span> (идентификатор клиента), </span><span><span>SalesPrice</span></span><span> (цена продажи) и </span><span><span>PurchaseDate</span></span><span> (дата приобретения). Затем добавляется запись в таблицу пересечения, чтобы зарегистрировать интерес клиента к данному художнику. В противном случае, если число найденных строк больше или меньше 1, никаких изменений в базе данных не производится.<o:p></o:p></span></p> <p><span>Параметры процедуры </span><span><span>NewCustomerWithTransaction</span></span><span> содержат информацию о клиенте и приобретенном произведении. В процедуре объявлены несколько переменных и курсор. Курсор определен на соединении таблиц </span><span>ARTIST</span><span>, </span><span>WORK</span><span> и </span><span>TRANSACTION</span><span>, Он выделяет столбцы </span><span><span>TransactionID</span></span><span> и </span><span>ARTIST</span><span>. </span><span><span><span>ArtistID</span></span></span><span><span> из строк, содержащих данные об искомом художнике и произведении и имеющих нулевое значение столбца </span><span><span>CustomerID</span></span><span>.</span></span><span><o:p></o:p></span></p> <p><span>Прежде <span>всего</span> процедура выполняет проверку, нет ли уже в базе данных информации о данном клиенте. Если нет, данные нового клиента добавляются в базу. В </span><span>PL</span><span>/</span><span>SQL</span><span> нет <span>оператора </span></span><span>BEGIN</span><span> </span><span>TRANSACTION</span><sup><span>1</span></sup><span> — первое действие с базой данных автоматически начинает транзакцию. Здесь новая транзакция начнется при добавлении данных о покупателе.<o:p></o:p></span></p> <p><span>После того как данные о новом покупателе добавлены в базу, обрабатывается курсор </span><span><span>TransCursor</span></span><span>. Переменная </span><span><span>rowcount</span></span><span> используется для подсчета строк, в переменную </span><span><span>tid</span></span><span> записывается значение </span><span><span>TransactionID</span></span><span>, а в переменную </span><span>aid</span><span> — значение </span><span><span>ArtistID</span></span><span>. Заметьте, что оператор присваивания в </span><span>Oracle</span><span> выглядит так: «:=». Например, </span><span><span>tid</span></span><span><span> :</span></span><span>= </span><span>trans</span><span>.</span><span><span>transactionID</span></span><span> обозначает, что в переменную </span><span><span>tid</span></span><span> записывается значение </span><span>trans</span><span>.</span><span><span>TransactionID</span></span><span>.<o:p></o:p></span></p> <p><span>В соответствии с логикой процедуры, если найдена одна и только одна строка, удовлетворяющая критериям, то в переменных </span><span><span>tid</span></span><span> и </span><span>aid</span><span> будут содержаться значения, нужные нам для успешного завершения транзакции. Если же таких строк не найдено или найдено более одной, то транзакция будет прервана, и ни </span><span><span>tid</span></span><span>, ни </span><span>aid</span><span> не будут использованы.<o:p></o:p></span></p> <p><span>Для подсчета строк мы могли бы использовать выражение </span><span>Count</span><span>(*), и затем, если </span><span>Count</span><span>(*) = 1, запустить другой оператор, который бы получал нужные нам значения </span><span>aid</span><span> и </span><span><span>tid</span></span><span>. При той логике, которая реализована и листинге 2, необходимость во втором SQL-операторе отпадает.<o:p></o:p></span></p> <p><span>Если число строк </span><span><span>RowCount</span></span><span> больше единицы или равно нулю, то выдается сообщение об ошибке и выполняется откат транзакции, отменяющий вставку данных в таблицу </span><span>CUSTOMER</span><span>. Если </span><span><span>RowCount</span></span><span> равно 1, обновляется соответствующая строка в таблице </span><span>TRANSACTION</span><span>. Обратите внимание на использование функции </span><span><span>SysDate</span></span><span>, с помощью которой записывается текущая дата. Наконец, в таблицу пересечения добавляется строка с информацией о покупателе и авторе купленного произведения (</span><span>aid</span><span>).<o:p></o:p></span></p> <p><span>Эта хранимая процедура может быть вызвана командой <span>наподобие</span><o:p></o:p></span></p> <p><span>Exec <span>NewCustorTierWithTransact1on(</span> 'Susan Wu', '206', '555-1000', '<span>Miro</span>', 'Mi Vida', 79/122', '65000');<o:p></o:p></span></p> <p><span>Следующие два оператора отображают данные после обновления:<o:p></o:p></span></p> <p><span>SELECT<span> </span><span>CUSTOMER.Name</span>, Copy, Title, <span>ARTIST.Name</span><o:p></o:p></span></p> <p><span>FROM<span> </span>CUSTOMER, TRANSACTION, WORK, ARTIST<o:p></o:p></span></p> <p><span>WHERE<span> </span><span> </span><span>CUSTOMER.CustomerID</span> = <span>TRANSACTION.CustomerID</span> AND<o:p></o:p></span></p> <p><span><span>TRANSACTION.WorkID</span></span><span> = <span>WORK.WorkID</span> AND<o:p></o:p></span></p> <div> <p><span><span>WORK.ArtistID</span></span><span> = <span>ARTIST.ArtistID</span>;<o:p></o:p></span></p> <p><span><o:p> </o:p></span></p> </div> <p><span>Будьте внимательны! Слово </span><span>TRANSACTION</span><span> используется<span> здесь в двух значениях:</span> как имя одной из таблиц в<span> базе данных галереи </span></span><span>View</span><span> </span><span>Ridge</span><span> и как</span><span> английское слово, обозначающее транзакцию — группу операторов,<span> выполняемых как</span> единое<span> целое.</span> Конкретное значение ясно из контекста, но имейте в виду, что<span> возможна путаница.<o:p></o:p></span></span></p> <p><span><o:p> </o:p></span></p> <p><span>SELECT<span> </span>CUSTOMER, Name, <span>ARTIST.Name</span><o:p></o:p></span></p> <p><span>FROM<span> </span>CUSTOMER, CUSTOMER_ARTST_INT. ARTIST<o:p></o:p></span></p> <p><span>WHERE<span> </span><span>CUSTOMER.CustomerID</span> • <span>CUSTOMER_ARTIST_lNT.CustonierID</span><o:p></o:p></span></p> <p><span><span> </span>AND<o:p></o:p></span></p> <p><span><span> </span><span>ARTIST.ArtfstID</span> - <span>CUSTOMER_ARTIST_INT.ArtistID</span>:<o:p></o:p></span></p> <p><span>Обратите внимание, что требуется два SQL-оператора, поскольку это представление базы данных имеет два многозначных пути. Оно не может быть представлено одним SQL-оператором (или SQL-представлением).<o:p></o:p></span></p> <p><span>Запустить процедуру.<o:p></o:p></span></p> <p><span>Вывести результаты запросов на экран.<o:p></o:p></span></p> <p><![if !supportLists]><b><span><span>4.<span> </span></span></span></b><![endif]><b><span>Порядок выполнения работы<o:p></o:p></span></b></p> <p><![if !supportLists]><span><span>1.<span> </span></span></span><![endif]><span>Ознакомиться с учебным материалом<o:p></o:p></span></p> <p><![if !supportLists]><span><span>2.<span> </span></span></span><![endif]><span>Модифицировать процедуру 1, обеспечив добавление всех данные о новых покупателях, с учетом их интереса к художникам определенных национальностей.<o:p></o:p></span></p> <p><![if !supportLists]><span><span>3.<span> </span></span></span><![endif]><span>Добавить 2 новых покупателей (вызов процедуры 1)<o:p></o:p></span></p> <p><![if !supportLists]><span><span>4.<span> </span></span></span><![endif]><span>Добавить в таблицу </span><span>CUSTOMER</span><span> новое поле </span><span>Second</span><span>_</span><span>Name</span><span><o:p></o:p></span></p> <p><![if !supportLists]><span><span>5.<span> </span></span></span><![endif]><span>Модифицировать процедуру 2.<o:p></o:p></span></p> <p><![if !supportLists]><span><span>6.<span> </span></span></span><![endif]><span>Добавить<a></a> 2-х новых покупателей (вызов процедуры 2)<o:p></o:p></span></p> <p><![if !supportLists]><span><span>7.<span> </span></span></span><![endif]><span>Согласовать с преподавателем содержание отчёта и подготовить его.</span><span><o:p></o:p></span></p> <p><o:p> </o:p></p> </div> 
 <A HREF="../practice.htm">Оглавление</A>               
 <p>&nbsp;</p>
        </table>
<table width="100%" height=25px border="0" cellpadding="0" cellspacing="3" bordercolor="#316AC5" background="../Оболочка/images/background.jpg">
  <tr >
  <td align=center><var><B><b>(С)  БГУИР</b></var></td>
  </tr>
</table>
</BODY></HTML>